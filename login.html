<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>بوابة الكورس — فيديوهات (حماية قصوى)</title>

<!-- Cairo font -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<!-- (يفضّل ضبط CSP/Permissions في هيدر السيرفر لو تقدر) -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; media-src 'self' blob: data:; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline';">
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), autoplay=(), screen-wake-lock=()">

<style>
  :root{
    --bg:#071017;
    --card:#0e1620;
    --muted:#9ab6c6;
    --accent1:#00d38f;
    --accent2:#ff8c00;
    --max-width:1100px;
    --yt-width: min(var(--max-width), 96vw);
    --yt-height: calc(var(--yt-width) * 9 / 16);
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
    background:
      radial-gradient(800px 500px at 10% -20%, rgba(0,211,143,.06), transparent 40%),
      radial-gradient(600px 400px at 110% 120%, rgba(255,140,0,.04), transparent 40%),
      linear-gradient(180deg,#071018 0%, #071018 100%);
    color:#e6f6ff; -webkit-font-smoothing:antialiased;
    -webkit-user-select:none; user-select:none;
  }

  /* topbar */
  .topbar{position:sticky;top:0;z-index:80;background:linear-gradient(180deg, rgba(4,10,14,.85), rgba(4,8,12,.72));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
  .topwrap{max-width:var(--max-width);margin:auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:900}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 6px 24px rgba(0,211,143,.08)}
  .clock{font-weight:900;color:#bfdef0;min-width:150px;text-align:center}
  .actionsbar{display:flex;gap:8px}
  .btn{appearance:none;border:0;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;color:#dff3ff;border:1px solid rgba(255,255,255,.04)}
  .btn.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#062018}

  /* toast */
  .toast{position:fixed;top:18px;right:18px;padding:10px 14px;border-radius:12px;font-weight:900;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#052018;z-index:120;box-shadow:0 12px 40px rgba(0,0,0,.6);opacity:0;transform:translateY(-8px);transition:.35s}
  .toast.show{opacity:1;transform:none}

  /* layout */
  .container{max-width:var(--max-width);margin:20px auto;padding:0 16px}
  .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  .who{font-weight:900;color:#dff6ff}
  .muted{color:var(--muted);font-weight:700;opacity:.9}

  /* login card */
  .center-card{display:grid;place-items:center;padding:28px}
  .card{width:min(720px,96vw);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:14px;padding:22px;border:1px solid rgba(255,255,255,.04);box-shadow:0 18px 60px rgba(0,0,0,.6)}
  .card-head{display:flex;flex-direction:column;gap:6px;margin-bottom:6px;text-align:center}
  .card-head h1{margin:0;font-size:20px;font-weight:900}
  .inputs{display:flex;gap:10px;flex-direction:column;margin-top:12px}
  .input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.04);background:#07131a;color:#e9fbff;outline:none;font-size:15px}

  /* motivation */
  .motivation{position:sticky;top:56px;z-index:60;background:linear-gradient(90deg, rgba(0,211,143,.02), rgba(255,140,0,.02));border-bottom:1px dashed rgba(255,255,255,.03)}
  .motivation .wrap{max-width:var(--max-width);margin:auto;padding:10px 16px;text-align:center;font-weight:900;color:#cfe6fb}
  .fade{opacity:0;transform:translateY(-6px);transition:.35s}
  .fade.show{opacity:1;transform:none}

  /* videos list (stacked like youtube) */
  #videos{display:flex;flex-direction:column;gap:26px;align-items:center;margin-top:18px}
  .vcard{width:100%;display:flex;flex-direction:column;align-items:center;gap:8px}
  .vhead{width:100%;max-width:var(--yt-width);display:flex;justify-content:space-between;align-items:center;padding:6px 8px;color:#dff7ff;font-weight:900}
  .vplayer{position:relative;width:100%;max-width:var(--yt-width);border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.03);background:#000}
  .video{width:100%;height:var(--yt-height);background:#000;display:block;object-fit:contain}
  .controls{display:flex;justify-content:space-between;align-items:center;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,.005))}
  .cbtn{background:transparent;border:1px solid rgba(255,255,255,.04);padding:8px 10px;border-radius:8px;color:#dff3ff;font-weight:900;cursor:pointer}

  /* watermark overlay */
  .wm{pointer-events:none;position:absolute;inset:0;z-index:14}
  .wm .tag{position:absolute;right:12px;bottom:10px;font-weight:900;font-size:13px;color:rgba(255,255,255,.92);text-shadow:0 2px 8px rgba(0,0,0,.6);opacity:.9}
  .wm .stamp{position:absolute;left:12px;bottom:10px;font-weight:700;font-size:12px;color:rgba(255,255,255,.75)}

  /* lock overlay */
  .lock{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;place-items:center;z-index:200}
  .lock .box{background:linear-gradient(180deg,#07131a,#091820);padding:28px;border-radius:12px;border:1px solid #15303a;color:#fff;text-align:center;max-width:520px}

  /* reveal animation */
  .reveal{opacity:0;transform:translateY(18px);transition:all .55s cubic-bezier(.2,.9,.2,1)}
  .reveal.visible{opacity:1;transform:none}

  /* responsive */
  @media (max-width:760px){
    :root{--yt-width: calc(100vw - 32px); --yt-height: calc(var(--yt-width) * 9 / 16)}
    .card{width:calc(100vw - 32px)}
  }
</style>
</head>
<body>

<!-- stars background canvas -->
<canvas id="stars" class="stars" aria-hidden="true"></canvas>

<!-- top bar -->
<div class="topbar">
  <div class="topwrap">
    <div class="brand"><span class="dot"></span><span>منصة الكورس (حماية قصوى)</span></div>
    <div class="clock" id="clock">--:--:--</div>
    <div class="actionsbar">
      <button class="btn ghost" id="backBtn" title="رجوع">⬅️</button>
      <button class="btn primary" id="panicBtn" title="خروج فوري">🚨 خروج</button>
    </div>
  </div>
</div>

<!-- motivation -->
<div class="motivation">
  <div class="wrap"><div id="motivationText" class="fade">✦ ابدأ الآن — الدقائق الصغيرة تصنع فرقًا كبيرًا.</div></div>
</div>

<!-- toast -->
<div id="toast" class="toast">🔒 الموقع مؤمّن</div>

<!-- lock overlay -->
<div id="lock" class="lock" aria-hidden="true">
  <div class="box">
    <h2>🚫 تم إغلاق الجلسة</h2>
    <p id="lockMsg">تم إنهاء الجلسة لأسباب أمنيّة.</p>
  </div>
</div>

<!-- login screen -->
<main id="login" class="center-card">
  <div class="card" role="dialog" aria-labelledby="login-title">
    <div class="card-head">
      <h1 id="login-title">تسجيل الدخول إلى الكورس</h1>
      <div class="muted">أدخل اسم المستخدم وكلمة المرور للمتابعة</div>
    </div>
    <div class="inputs">
      <input id="u" class="input" placeholder="مثال: dr2025001" autocomplete="username" />
      <input id="p" class="input" placeholder="••••••••" type="password" autocomplete="current-password" />
      <div style="display:flex;gap:10px">
        <button id="loginBtn" class="btn primary">دخول</button>
        <button id="clearBtn" class="btn ghost">مسح</button>
      </div>
      <div id="err" class="muted" style="margin-top:8px;height:20px"></div>
      <div style="margin-top:10px"><small class="muted">محمي — محاولة النسخ أو التصوير داخل المتصفح قد تُنهِي الجلسة</small></div>
    </div>
  </div>
</main>

<!-- app (hidden until login) -->
<section id="app" style="display:none;opacity:0">
  <div class="container">
    <div class="header-row">
      <div class="who" id="who"></div>
      <div style="display:flex;gap:8px">
        <button id="logoutBtn" class="btn ghost">تسجيل الخروج</button>
      </div>
    </div>

    <!-- videos will be injected here -->
    <div id="videos"></div>
  </div>
</section>

<script>
/* =================== بيانات (عدل هنا) =================== */
// أضف/احذف أو غير أسماء المستخدمين هنا
const users = [
  { username: "dr2025001", password: "QK472" },
  { username: "dr2025002", password: "HB915" },
  { username: "dr2025003", password: "MT648" },
  { username: "dr2025004", password: "ZW183" },
  { username: "dr2025005", password: "LC592" },
  { username: "dr2025006", password: "FD706" },
  { username: "dr2025007", password: "AX354" },
  { username: "dr2025008", password: "VE801" },
  { username: "dr2025009", password: "JP627" },
  { username: "dr2025010", password: "RY548" },
  { username: "dr2025011", password: "NU269" },
  { username: "dr2025012", password: "TB940" },
  { username: "dr2025013", password: "GK731" },
  { username: "dr2025014", password: "WM825" },
  { username: "dr2025015", password: "CQ174" },
  { username: "dr2025016", password: "SZ396" },
  { username: "dr2025017", password: "PH209" },
  { username: "dr2025018", password: "OV651" },
  { username: "dr2025019", password: "EY384" },
  { username: "dr2025020", password: "BJ972" },
  { username: "dr2025021", password: "LF103" },
  { username: "dr2025022", password: "KI854" },
  { username: "dr2025023", password: "MX427" },
  { username: "dr2025024", password: "HD769" },
  { username: "dr2025025", password: "QG295" },
  { username: "dr2025026", password: "RN618" },
  { username: "dr2025027", password: "ZW587" },
  { username: "dr2025028", password: "YS230" },
  { username: "dr2025029", password: "AJ953" },
  { username: "dr2025030", password: "UC467" },
  { username: "dr2025031", password: "TE982" },
  { username: "dr2025032", password: "BL719" },
  { username: "dr2025033", password: "VP306" },
  { username: "dr2025034", password: "OS840" },
  { username: "dr2025035", password: "XR594" },
  { username: "dr2025036", password: "DW718" },
  { username: "dr2025037", password: "MC285" },
  { username: "dr2025038", password: "HQ964" },
  { username: "dr2025039", password: "NY431" },
  { username: "dr2025040", password: "FB609" },
  { username: "dr2025041", password: "LS284" },
  { username: "dr2025042", password: "PU719" },
  { username: "dr2025043", password: "ZC517" },
  { username: "dr2025044", password: "KM402" },
  { username: "dr2025045", password: "YG835" },
  { username: "dr2025046", password: "AD790" },
  { username: "dr2025047", password: "RJ652" },
  { username: "dr2025048", password: "VH291" },
  { username: "dr2025049", password: "OE547" },
  { username: "dr2025050", password: "TI386" },
  { username: "dr2025051", password: "CN482" },
  { username: "dr2025052", password: "QZ178" },
  { username: "dr2025053", password: "WS690" },
  { username: "dr2025054", password: "ML520" },
  { username: "dr2025055", password: "PX947" },
  { username: "dr2025056", password: "FV613" },
  { username: "dr2025057", password: "GE294" },
  { username: "dr2025058", password: "BY740" },
  { username: "dr2025059", password: "HU835" },
  { username: "dr2025060", password: "AK507" },
  { username: "dr2025061", password: "XQ392" },
  { username: "dr2025062", password: "ZL681" },
  { username: "dr2025063", password: "DR158" },
  { username: "dr2025064", password: "OE473" },
  { username: "dr2025065", password: "SJ594" },
  { username: "dr2025066", password: "KF819" },
  { username: "dr2025067", password: "UL280" },
  { username: "dr2025068", password: "PQ967" },
  { username: "dr2025069", password: "VR136" },
  { username: "dr2025070", password: "NW548" },
  { username: "dr2025071", password: "HZ209" },
  { username: "dr2025072", password: "CG874" },
  { username: "dr2025073", password: "LB705" },
  { username: "dr2025074", password: "TP491" },
  { username: "dr2025075", password: "EJ602" },
  { username: "dr2025076", password: "MY253" },
  { username: "dr2025077", password: "FS980" },
  { username: "dr2025078", password: "QO178" },
  { username: "dr2025079", password: "VK320" },
  { username: "dr2025080", password: "AI695" },
  { username: "dr2025081", password: "ZR586" },
  { username: "dr2025082", password: "DY403" },
  { username: "dr2025083", password: "GW217" },
  { username: "dr2025084", password: "XT950" },
  { username: "dr2025085", password: "JE184" },
  { username: "dr2025086", password: "UC729" },
  { username: "dr2025087", password: "PM604" },
  { username: "dr2025088", password: "KV315" },
  { username: "dr2025089", password: "RX890" },
  { username: "dr2025090", password: "BQ278" },
  { username: "dr2025091", password: "NH542" },
  { username: "dr2025092", password: "LV631" },
  { username: "dr2025093", password: "SW907" },
  { username: "dr2025094", password: "EA756" },
  { username: "dr2025095", password: "YM428" },
  { username: "dr2025096", password: "ZT903" },
  { username: "dr2025097", password: "DG547" },
  { username: "dr2025098", password: "KU362" },
  { username: "dr2025099", password: "HP690" },
  { username: "dr2025100", password: "OF284" }
];

// ضع ملفات الفيديو داخل مجلد videos/ بنفس الأسماء
const videoFiles = [
  'video1.mp4',
  'video2.mp4',
  'video3.mp4',
  'video4.mp4'
];

/* =================== متغيرات حالة =================== */
let currentUser = null;
let okUntil = 0;           // نافذة سماح للتفاعل
let suppressOnce = false;  // لتجاهل أول تغيير عندما يكون مشروع
const ANGRY = '😡 محاولة غير مسموح بها — تم إغلاق الجلسة فورًا.';
const qs = (s,p=document) => p.querySelector(s);
const qsa = (s,p=document) => [...p.querySelectorAll(s)];

function showToast(msg){
  const t = qs('#toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 2200);
}

/* =================== الساعة =================== */
function tickClock(){
  try{
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('ar-EG',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Africa/Cairo'});
    qs('#clock').textContent = fmt.format(now);
  }catch{ qs('#clock').textContent = new Date().toLocaleTimeString(); }
}
setInterval(tickClock,1000); tickClock();

/* =================== تجول جُمل تحفيزية =================== */
const MOTIVATIONS = [
  '✦ ابدأ الآن — الدقائق الصغيرة تصنع فرقًا كبيرًا.',
  '✦ كل فيديو تنهيه يقرّبك من هدفك.',
  '✦ التزامك اليوم = ثقة أكبر غدًا.',
  '✦ لا تنتظر المثالية — تقدّم خطوة.',
  '✦ تعلّم بتركيز، راحة قصيرة، ثم عُد بقوة.',
  '✦ العلم رزق، ونيّتك الطيبة تفتح الأبواب.',
  '✦ أنت أقوى مما تظن — كمل للآخر.'
];
(function rotateMotivation(){
  const el = qs('#motivationText'); let i=0;
  setInterval(()=>{
    el.classList.remove('show');
    setTimeout(()=>{ el.textContent = MOTIVATIONS[(++i)%MOTIVATIONS.length]; el.classList.add('show'); }, 260);
  }, 5200);
  requestAnimationFrame(()=> qs('#motivationText').classList.add('show'));
})();

/* =================== عناصر DOM - تسجيل دخول =================== */
qs('#loginBtn').addEventListener('click', ()=>{
  const u = qs('#u').value.trim(), p = qs('#p').value.trim();
  if(!u || !p){ qs('#err').textContent = 'من فضلك أدخل البيانات كاملة'; return; }
  if(!/^dr2025\d{3}$/i.test(u)){ qs('#err').textContent = 'صيغة اسم المستخدم يجب أن تكون مثل: dr2025001'; return; }
  if(!users.some(x => x.username === u && x.password === p)){ qs('#err').textContent = '❌ اسم المستخدم أو كلمة المرور غير صحيحة'; return; }
  qs('#err').textContent = ''; currentUser = u; qs('#who').textContent = `مرحبًا، ${u}`;
  renderVideos(); enterApp();
});
qs('#clearBtn').addEventListener('click', ()=>{ qs('#u').value=''; qs('#p').value=''; qs('#err').textContent=''; });
qs('#logoutBtn').addEventListener('click', ()=> forceLogout('🚪 تم تسجيل الخروج'));
qs('#panicBtn').addEventListener('click', ()=> forceLogout('⛔ انتهاء الجلسة'));
qs('#backBtn').addEventListener('click', ()=> { try{ history.length>1 ? history.back() : location.replace('/'); }catch{ location.replace('/'); } });

function enterApp(){
  qs('#login').style.display = 'none';
  const app = qs('#app'); app.style.display = 'block';
  requestAnimationFrame(()=> app.style.opacity = 1);
  showToast('🎉 تم الدخول — مرحبًا بك');
}

/* =================== render videos (YouTube-like stacked cards) =================== */
function renderVideos(){
  const wrap = qs('#videos'); wrap.innerHTML = '';
  videoFiles.forEach((src, idx) => {
    const id = idx + 1;
    const article = document.createElement('article');
    article.className = 'vcard reveal';
    article.innerHTML = `
      <div class="vhead">
        <div>🎬 الفيديو ${id}</div>
        <div style="color:var(--accent2);font-weight:900">تشغيل فقط</div>
      </div>
      <div class="vplayer">
        <div class="wm"></div>
        <video class="video" preload="metadata" playsinline controls controlslist="nodownload noremoteplayback" src="${src}"></video>
        <div class="controls">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="cbtn play">تشغيل/إيقاف</button>
            <button class="cbtn back">◀︎ 10s</button>
            <button class="cbtn fwd">10s ▶︎</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="time t">00:00 / 00:00</span>
            <button class="cbtn fs">ملء</button>
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(article);

    // بعد الإضافة نفعل الوتَرمارك ونربط الكنترولز
    const v = article.querySelector('.video');
    const wm = article.querySelector('.wm');
    // نص الوترمارك: اسم المستخدم ووقت التحميل
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.textContent = currentUser || '';
    wm.appendChild(tag);
    const stamp = document.createElement('span');
    stamp.className = 'stamp';
    stamp.textContent = new Date().toLocaleString('ar-EG', { timeZone:'Africa/Cairo' });
    wm.appendChild(stamp);
    startFloatingWM(tag);

    // عناصر التحكم
    const playBtn = article.querySelector('.play');
    const backBtn = article.querySelector('.back');
    const fwdBtn  = article.querySelector('.fwd');
    const fsBtn   = article.querySelector('.fs');
    const tLabel  = article.querySelector('.t');

    // نافذة سماح للتغييرات المشروعة (مثل فتح إعدادات الفيديو أو التكبير)
    ['pointerenter','mousemove','click','touchstart','play','pause','seeking','volumechange'].forEach(ev=>{
      v.addEventListener(ev, ()=> allowVideoInteraction(2200), {passive:true});
    });

    // ملاحظة: نترك قائمة الفيديو (context menu) للعمل -- المستخدم يقدر يفتح إعدادات الفيديو
    // لكن نمنع الكليك يمين في الصفحة العامة
    // (لا نمنع داخل الفيديو هنا so user can use settings)

    playBtn.addEventListener('click', ()=> { try{ if(v.paused) v.play(); else v.pause(); }catch{} });
    backBtn.addEventListener('click', ()=> { try{ v.currentTime = Math.max(0, v.currentTime - 10); }catch{} });
    fwdBtn.addEventListener('click', ()=> { try{ v.currentTime = Math.min((v.duration||0), v.currentTime + 10); }catch{} });
    fsBtn.addEventListener('click', ()=> {
      allowVideoInteraction(2600);
      const el = v.closest('.vplayer');
      if(!document.fullscreenElement) el.requestFullscreen?.().catch(()=>{});
      else document.exitFullscreen?.catch(()=>{});
    });

    // update time label
    function fmt(t){ if(!isFinite(t)) return '00:00'; const m=Math.floor(t/60); const s=Math.floor(t%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
    v.addEventListener('timeupdate', ()=> { tLabel.textContent = `${fmt(v.currentTime)} / ${fmt(v.duration||0)}`; });
    v.addEventListener('loadedmetadata', ()=> { tLabel.textContent = `${fmt(0)} / ${fmt(v.duration||0)}`; });

    // if video fails to load, show note
    v.addEventListener('error', ()=> {
      const note = document.createElement('div'); note.className='muted'; note.style.padding='10px'; note.textContent = '⚠️ تعذر تحميل الفيديو — تأكد من المسار.';
      article.appendChild(note);
    });
  });

  // reveal animation for cards
  const reveals = qsa('.reveal');
  const obs = new IntersectionObserver(entries => {
    entries.forEach(en => { if(en.isIntersecting){ en.target.classList.add('visible'); obs.unobserve(en.target); } });
  }, { threshold: 0.12 });
  reveals.forEach(r => obs.observe(r));
}

/* =============== floating watermark movement =============== */
function startFloatingWM(el){
  if(!el) return;
  const parent = el.closest('.vplayer') || el.parentElement;
  const move = ()=>{
    try{
      const r = parent.getBoundingClientRect();
      const pad = 30;
      const x = Math.random() * Math.max(1, r.width - pad*2) + pad;
      const y = Math.random() * Math.max(1, r.height - pad*2) + pad;
      el.style.transform = `translate(${x}px, ${y}px)`;
      el.style.opacity = String(0.6 + Math.random()*0.35);
    }catch{}
  };
  move();
  setInterval(move, 2200 + Math.random()*1200);
}

/* =============== حماية / منع تصوير (تقريبي) =============== */
/* ملاحظات: لا يمكن حظر تسجيل الشاشة على مستوى نظام التشغيل. هذه إجراءات تقلّل من النسخ داخل المتصفح. */

function blockForCapture(extra){
  if(!currentUser) return;
  const msg = `🚫 ممنوع أخذ لقطة شاشة أو تسجيل الشاشة${extra? ' — ('+extra+')' : ''}`;
  forceLogout(msg);
}

/* منع كليك يمين على الصفحة عامة، لكن نسمح داخل عناصر الفيديو نفسها (حتى لو فتح المستخدم إعدادات الفيديو) */
document.addEventListener('contextmenu', e=>{
  // إذا الهدف عنصر video أو داخل vplayer فلا نمنع
  if(e.target && (e.target.closest && e.target.closest('.vplayer'))) return;
  e.preventDefault();
  if(currentUser) blockForCapture('كليك يمين');
  return false;
}, true);

/* منع عمليات النسخ/قص/لصق/selectstart/dragstart */
['copy','cut','paste','selectstart','dragstart'].forEach(ev=>{
  document.addEventListener(ev, e=>{
    e.preventDefault();
    if(currentUser) blockForCapture(ev);
  }, true);
});

/* منع اختصارات شائعة + PrintScreen + F12 */
document.addEventListener('keydown', (e)=>{
  const key = e.key || '';
  const ctrl = e.ctrlKey || e.metaKey;
  const sh = e.shiftKey;
  const lowered = key.toLowerCase();
  const suspicious =
    (ctrl && ['s','u','p','a','c','x'].includes(lowered)) ||    // ctrl+s / ctrl+u / ...
    (ctrl && sh && ['i','j','c'].includes(lowered)) ||          // ctrl+shift+i / j / c
    key === 'F12' ||
    key === 'PrintScreen' ||
    (e.metaKey && sh && ['3','4','5'].includes(lowered));
  if(suspicious){
    e.preventDefault();
    e.stopPropagation();
    if(currentUser) blockForCapture(`مفتاح ${key}`);
  }
}, true);

/* قبل الطباعة */
window.onbeforeprint = ()=> { if(currentUser) blockForCapture('طباعة'); };

/* visibility / blur / resize detection */
function allowVideoInteraction(ms = 2200){ okUntil = Date.now() + ms; suppressOnce = true; }
function isSafeInteraction(){ return Date.now() < okUntil; }

document.addEventListener('visibilitychange', ()=> {
  if(!currentUser) return;
  if(document.hidden){
    if(suppressOnce){ suppressOnce = false; return; }
    if(!isSafeInteraction()) blockForCapture('إخفاء التبويب/تصوير');
  }
});
window.addEventListener('blur', ()=> { if(currentUser && !isSafeInteraction()) blockForCapture('فقدان تركيز'); });

let lastW = window.innerWidth, lastH = window.innerHeight;
window.addEventListener('resize', ()=> {
  if(!currentUser) return;
  const dw = Math.abs(window.innerWidth - lastW), dh = Math.abs(window.innerHeight - lastH);
  lastW = window.innerWidth; lastH = window.innerHeight;
  if((dw>240 || dh>240) && !isSafeInteraction()) blockForCapture('تبديل شاشة/تسجيل محتمل');
});

/* devtools heuristic (تقريبي) */
let devCheck = setInterval(()=>{
  try{
    const bigGap = (window.outerWidth - window.innerWidth) > 160 || (window.outerHeight - window.innerHeight) > 160;
    if(bigGap && currentUser) return blockForCapture('DevTools');
    const x = { get id(){ if(currentUser) blockForCapture('Console Open'); } };
    console.log(x);
    let t = performance.now();
    for(let i=0;i<100000;i++){}
    if(performance.now() - t > 250 && currentUser) blockForCapture('Debug Slow');
  }catch{}
}, 1500);

/* force logout / hard exit */
function forceLogout(msg){
  currentUser = null;
  try{ qs('#who').textContent = ''; }catch{}
  const lock = qs('#lock'); qs('#lockMsg').textContent = msg || ANGRY; lock.style.display = 'grid';
  setTimeout(()=> {
    try{ sessionStorage.clear(); localStorage.clear(); }catch{}
    try{ document.body.innerHTML = ''; }catch{}
    try{ window.stop(); }catch{}
    try{ location.replace('about:blank'); }catch{}
  }, 260);
}

/* =============== stars canvas =============== */
(function stars(){
  const c = qs('#stars'); if(!c) return;
  const ctx = c.getContext('2d');
  let w,h,stars=[];
  function resize(){ w=c.width=innerWidth; h=c.height=innerHeight; stars = Array.from({length:Math.min(260, Math.floor(w*h/9000))}, ()=>({
    x: Math.random()*w, y: Math.random()*h, z: Math.random()*1.6 + .2, r: Math.random()*1.6 + .2, o: Math.random()*.6 + .15
  })); }
  resize(); addEventListener('resize', resize);
  function frame(){
    ctx.clearRect(0,0,w,h);
    for(const s of stars){
      s.x += Math.sin(performance.now()/1200)*0.02 * s.z;
      s.y += 0.04*s.z;
      if(s.y>h){ s.y=-5; s.x=Math.random()*w; }
      ctx.globalAlpha = s.o;
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fillStyle='#7fc9ff'; ctx.fill();
    }
    requestAnimationFrame(frame);
  }
  frame();
})();

/* =============== startup message =============== */
showToast('🔒 الموقع مؤمّن — أي محاولة نسخ/تصوير = خروج فوري');
</script>
</body>
</html>

